# 12.1 웹사이트와 성능

- 웹사이트의 성능은 사용자의 전자상거래 전환율이나 이탈율과 밀접하게 관련되어 있습니다. 현재 네트워크 속도나 모바일 기기의 성능은 발전하고 있지만 그와 동시에 여전히 대부분의 모바일 사이트는 너무 많은 요소 때문에 비대해지기도 했습니다. 많은 개발자들이 성능에 크게 관심을 기울이지 않는 것 또한 사실인데, 실무에서 일정을 넉넉히 잡고 성능을 개선하는 것이 쉽지 않을 뿐더러 작업 대비 눈에 띄는 성능 향상을 기대하기도 어렵기 때문입니다.
- 그럼에도 불구하고 앞서 전환율이나 이탈율을 고려해서 웹사이트의 성능에 주의를 기울여야 합니다. 과거에는 로딩 속도나 전환율 등으로 지엽적으로 판단했지만, 몇 년 전부터 구글은 핵심 웹 지표(Core Web Vital)이라고 하는, 사용자 경험에 대해 몇 가지 핵심 지표를 제시하고 있습니다.

# 12.2 핵심 웹 지표란?

- 핵심 웹 지표(Core Web Vital)은 사용자 경험을 제공하는 데 필수적인 지표를 일컫는 용어입니다. 일관된 판단을 위해 구글은 핵심적인 웹 지표를 몇 가지로 요약하고, 이를 측정할 수 있는 방법, 좋은 웹사이트의 기준을 명확하게 제시해두었습니다.

# 12.3 최대 콘텐츠풀 페인트(LCP)

## 12.3.1 정의

- LCP(Largest Contentful Paint)란 ‘페이지가 처음으로 로드를 시작한 시점부터 뷰포트 내부에서 가장 큰 이미지 또는 텍스트를 렌더링하는 데 걸리는 시간’을 말합니다.
- 뷰포트는 사용자마다, 즉 기기마다 다른데 ‘큰 이미지와 텍스트’는 다음과 같이 정의되어 있습니다.
  - <img>
  - <svg> 내부의 <image>
  - poster 속성을 사용하는 <video>
  - url()을 통해 불러온 배경 이미지가 있는 요소
  - 텍스트와 같이 인라인 텍스트 요소를 포함하고 있는 블록 레벨 요소
    - 이 블록 레벨 요소에는 <p>, <div> 등 포함

## 12.3.2 의미

- DOMContentLoaded 이벤트는 스타일시트나 이미지 등의 로딩을 기다리지 않기 때문에 ‘웹페이지가 로딩이 완료되어 사용자에게 노출되기까지 걸리는 시간’이라고 보기는 어렵습니다. 또한 사용자 페이지 로딩을 체감하기 위해서 모든 페이지를 로딩될 필요가 없기 때문에 뷰포트를 기준으로 하는 LCP가 지표로 만들어졌다고 볼 수 있습니다.

## 12.3.3 예제

- 페이지에 따라서, 실제로 로딩에 필요한 시간에 따라서 LCP의 대상, 혹은 지표가 달라질 수 있습니다.

## 12.3.4 기준 점수

- LCP에서 좋은 점수는 2.5초 내로 응답이 오는 것이고, 4초 이내는 보통, 그 이상은 나쁨으로 판단됩니다.

## 12.3.5 개선 방안

### 텍스트는 언제나 옳다

- 조율을 통해 가능하다면 이미지보다 텍스트로 뷰포트 최대 영역을 채우는 것이 가장 좋기는 합니다.

### 이미지를 어떻게 불러올 것인가?

```html
<!-- 1) img -->
<img src="lcp.jpg" ... />

<!-- 2) svg -->
<svg xmlns="http://www.w3.org/1000/svg">
  <image href="lcp.jpg" />
</svg>

<!-- 3) (비디오의 경우) video.poster -->
<video poster="lcp.jpg"></video>

<!-- 4) background-image: url() -->
<div style="background-image: url(lcp.jpg)">...</div>
```

- `<img>`: 이미지는 브라우저의 프리로드 스캐너에 의해서 먼저 발견되어 빠르게 요청이 일어납니다. 프리로드 스캐너란 HTML 파싱 단계를 차단하지 않고 이미지와 같이 빠르게 미리 로딩하면 좋은 리소스를 먼저 로딩하는 브라우저의 기능인데, `<img>` 내부의 리소스를 프리로드 스캐너가 병렬적으로 리소스를 다운로드하므로 LCP 요소를 불러오기에 적절합니다. `<picture>`도 동일합니다.
- `<svg>`: `<svg>` 내부의 `<img>`가 로딩이 완료되기 전에는 LCP가 완료되지 않고, `<img>`와 다르게 리소스를 모두 불러온 다음에 이미지를 불러온다는 것입니다. 즉, 프리로드 스캐너에 발견되지 않아 병렬 다운로드가 일어나지 않기 때문에 LCP 점수에 악영향을 주기에 이러한 방식은 삼가는 것이 좋습니다.
- `<video>`의 `poster`: 이 역시 프리로드 스캐너에 발견되어 `<img>`와 같은 성능을 나타내는데, `poster`가 없는 경우 `video`를 로딩해 첫 번째 프레임을 삽입해주기 때문에 `video`가 LCP에 영향을 줄 것 같다면 `poster`를 반드시 넣어주는 것이 좋습니다.
- `background-image: url()`: `background-image`를 비롯해서 CSS 리소스는 DOM을 그릴 준비가 될 때까지 리소스 요청을 미루기 때문에 LCP에 좋은 영향을 미치지 않습니다.

### 그 밖에 조심해야 할 사항

- 이미지 무손실 압축: 당연한 얘기지만 가능한 무손실 형식으로 압축해 최소한의 용량으로 서비스하는 것이 좋습니다.
- `loading=lazy` 주의: `loading=lazy`는 리소스를 중요하지 않음으로 표시하고 필요할 때만 로드하는 전략으로, `<img>`, `<iframe>` 등에 적용할 수 있지만 문제는 LCP의 이미지는 중요하지 않은 리소스로 분류해서는 안될 뿐더러, 로딩 속도만 늦출 뿐 지표 점수에는 도움이 되지 않습니다. 상대적으로 중요하지 않은 이미지에는 사용해도 좋지만 LCP 이미지에는 사용하지 않는 것이 좋습니다.
- `fadein` 같은 각종 애니메이션: 단순 이미지보다 당연히 LCP도 그만큼 늦어집니다.
- 서버에서 빌드해온 HTML을 프리로드 스캐너가 바로 읽어서 LCP로 빠르게 가져가기 때문에 SSR이 유리합니다.
- LCP 관련 리소스는 직접 호스팅: 가능하다면 같은 도메인에서 직접 호스팅하는 편이 좋습니다. 다른 출처(origin)에서 정제한 이미지를 가져오는 것은 이미 연결이 맺어진 현재 출처와는 다르게 완전히 새로운 출처의 경우 네트워크 커넥션부터 다시 수행해야 하기 때문에 최적화에 좋은 영향을 주진 않습니다.

# 12.4 최초 입력 지연(FID)

## 12.4.1 정의

- 웹페이지의 로딩 속도만큼 중요한 것이 웹사이트의 반응 속도인데, 이런 웹사이트의 반응성을 측정하는 지표가 바로 최초 입력 지연(FID)입니다. 사용자가 페이지와 처음 상호 작용할 때부터 해당 상호 작용에 대한 응답으로 브라우저가 실제로 이벤트 핸들러 처리를 시작하기까지 시간을 측정합니다.

## 12.4.2 의미

- 웹사이트 내에 이벤트 반응이 늦어지는 이유는 대규모 렌더링이 일어나거나 자바스크립트 분석 등을 이유로 메인 스레드가 작업을 처리하는 데에 리소스를 할애하고 있기 때문입니다. 자바스크립트 실행 환경은 ‘싱글 스레드’이기 때문에 그 외의 이벤트 리스너 같은 작업을 실행할 수 없어 지연이 발생하게 됩니다.
- 클릭, 터치, 타이핑 등 사용자의 개별 입력 작업에 초점을 맞추고 측정되고, 스크롤이나 핀치 투 줌 등은 애니메이션으로 분류해 측정 대상에서 제외됩니다.
- 구글은 사용자 경험을 크게 4가지로 분류해 정의하는데, 이를 RAIL이라고 합니다.
  - Response: 사용자 입력에 대한 반응 속도, 50ms 미만으로 이벤트를 처리할 것
  - Animation: 애니메이션의 각 프레임을 10ms 이하로 생성할 것
  - Idle: 유휴 시간을 극대화해 페이지가 50ms 이내에 사용자 입력에 응답하도록 할 것
  - Load: 5초 이내에 콘텐츠를 전달하고 인터렉션을 준비할 것
- FID는 R에 해당하는 응답에 초점을 맞추고 있습니다.

## 12.4.3 예제
